// Modelo de dados do ERP Unificado
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===== USUÁRIOS E AUTENTICAÇÃO =====
model Usuario {
  id        String   @id @default(uuid())
  nome      String
  email     String   @unique
  senha     String
  role      String   @default("vendedor") // admin, gerente, vendedor
  ativo     Boolean  @default(true)
  criadoEm  DateTime @default(now())
  
  vendas          Venda[]
  orcamentos      Orcamento[]
  pedidos         Pedido[]
  custosPedido    CustoPedido[]
  notifications   Notification[]
}

// ===== CADASTROS =====
model Cliente {
  id              String    @id @default(uuid())
  nome            String
  cpfCnpj         String    @unique
  email           String?
  telefone        String?
  endereco        String?
  cidade          String?
  estado          String?
  cep             String?
  limiteCredito   Decimal   @default(0) @db.Decimal(10, 2)
  saldoCredito    Decimal   @default(0) @db.Decimal(10, 2)
  saldoDevedor    Decimal   @default(0) @db.Decimal(10, 2)
  ativo           Boolean   @default(true)
  criadoEm        DateTime  @default(now())
  
  vendas          Venda[]
  carnes          Carne[]
  contasReceber   ContaReceber[]
  orcamentos      Orcamento[]
  pedidos         Pedido[]

  @@index([cpfCnpj])
  @@index([ativo])
  @@index([nome])
}

model Fornecedor {
  id        String   @id @default(uuid())
  nome      String
  cnpj      String   @unique
  email     String?
  telefone  String?
  endereco  String?
  ativo     Boolean  @default(true)
  criadoEm  DateTime @default(now())
  
  contasPagar     ContaPagar[]
  pedidosCompra   PedidoCompra[]
}

model Produto {
  id              String    @id @default(uuid())
  codigo          String    @unique
  nome            String
  descricao       String?
  categoria       String?
  unidade         String    @default("UN")
  precoVenda      Decimal   @db.Decimal(10, 2)
  precoCusto      Decimal   @default(0) @db.Decimal(10, 2)
  estoqueAtual    Int       @default(0)
  estoqueMinimo   Int       @default(0)
  ativo           Boolean   @default(true)
  criadoEm        DateTime  @default(now())
  
  variacoes       ProdutoVariacao[]
  movimentacoes   MovimentacaoEstoque[]
  itensVenda      ItemVenda[]
  itensOrcamento  ItemOrcamento[]
  itensPedido     ItemPedido[]
  itensPedidoCompra ItemPedidoCompra[]
  
  @@index([codigo])
  @@index([ativo])
  @@index([nome])
}

model ProdutoVariacao {
  id          String  @id @default(uuid())
  produtoId   String
  atributo    String  // cor, tamanho, etc
  valor       String  // vermelho, G, etc
  adicionalPreco Decimal @default(0) @db.Decimal(10, 2)
  
  produto     Produto @relation(fields: [produtoId], references: [id], onDelete: Cascade)
}

// ===== LOJAS =====
model Loja {
  id        String   @id @default(uuid())
  nome      String
  codigo    String   @unique
  endereco  String?
  telefone  String?
  ativo     Boolean  @default(true)
  criadoEm  DateTime @default(now())
  
  vendas    Venda[]
  
  @@index([codigo])
  @@index([ativo])
}

// ===== VENDAS =====
model Venda {
  id              String    @id @default(uuid())
  numero          String    @unique
  clienteId       String?
  usuarioId       String
  lojaId          String?
  dataVenda       DateTime  @default(now())
  subtotal        Decimal   @db.Decimal(10, 2)
  desconto        Decimal   @default(0) @db.Decimal(10, 2)
  total           Decimal   @db.Decimal(10, 2)
  formaPagamento  String    // dinheiro, cartao_credito, cartao_debito, pix, boleto, crediario
  statusPagamento String    @default("pendente") // pendente, pago, cancelado
  status          String    @default("concluida") // orcamento, concluida, cancelada
  observacoes     String?
  
  // Campos específicos de crediário
  modoCrediario              String?   // PADRAO, PERSONALIZADO, MANUAL
  usaTaxaPadrao              Boolean   @default(true)
  taxaPersonalizadaMensal    Decimal?  @db.Decimal(5, 2)
  tipoJurosPersonalizado     String?   // SIMPLES, COMPOSTO
  
  cliente         Cliente?  @relation(fields: [clienteId], references: [id])
  usuario         Usuario   @relation(fields: [usuarioId], references: [id])
  loja            Loja?     @relation(fields: [lojaId], references: [id])
  itens           ItemVenda[]
  carne           Carne?
  pedidos         Pedido[]
  contaReceber    ContaReceber?
}

model ItemVenda {
  id          String  @id @default(uuid())
  vendaId     String
  produtoId   String?
  quantidade  Int
  precoUnit   Decimal @db.Decimal(10, 2)
  subtotal    Decimal @db.Decimal(10, 2)
  
  venda       Venda   @relation(fields: [vendaId], references: [id], onDelete: Cascade)
  produto     Produto? @relation(fields: [produtoId], references: [id])
}

// ===== CREDIÁRIO / CARNÊ =====
model Carne {
  id              String    @id @default(uuid())
  vendaId         String    @unique
  clienteId       String
  numeroCarne     String    @unique
  valorTotal      Decimal   @db.Decimal(10, 2)
  valorOriginal   Decimal   @db.Decimal(10, 2) // valor sem juros
  numParcelas     Int
  taxaJuros       Decimal   @db.Decimal(5, 2) // % mensal
  valorJuros      Decimal   @db.Decimal(10, 2) // total de juros
  dataCriacao     DateTime  @default(now())
  status          String    @default("ativo") // ativo, quitado, cancelado
  
  venda           Venda     @relation(fields: [vendaId], references: [id])
  cliente         Cliente   @relation(fields: [clienteId], references: [id])
  parcelas        Parcela[]
}

model Parcela {
  id                        String    @id @default(uuid())
  carneId                   String
  numeroParcela             Int
  dataVencimento            DateTime
  valorParcela              Decimal   @db.Decimal(10, 2)
  
  // Breakdown detalhado
  valorPrincipal            Decimal   @db.Decimal(10, 2)  // Parte sem juros
  valorJurosPrevisto        Decimal   @default(0) @db.Decimal(10, 2)  // Juros previstos
  valorDescontoAntecipacao  Decimal   @default(0) @db.Decimal(10, 2)  // Desconto por pagar antes
  valorTotalPrevisto        Decimal   @db.Decimal(10, 2)  // Principal + Juros
  
  // Pagamento
  valorPago                 Decimal   @default(0) @db.Decimal(10, 2)
  dataPagamento             DateTime?
  diasAtraso                Int       @default(0)
  jurosMora                 Decimal   @default(0) @db.Decimal(10, 2)
  multaAtraso               Decimal   @default(0) @db.Decimal(10, 2)
  status                    String    @default("pendente") // pendente, pago, atrasado, cancelado
  
  carne                     Carne     @relation(fields: [carneId], references: [id], onDelete: Cascade)
  contaReceber              ContaReceber?
}

// ===== ESTOQUE =====
model MovimentacaoEstoque {
  id          String    @id @default(uuid())
  produtoId   String
  tipo        String    // entrada, saida, ajuste
  quantidade  Int
  motivo      String?
  data        DateTime  @default(now())
  
  produto     Produto   @relation(fields: [produtoId], references: [id])
}

// ===== FINANCEIRO =====
model Categoria {
  id          String   @id @default(uuid())
  nome        String
  tipo        String   // receita, despesa
  cor         String?  // hex color para UI
  icone       String?  // emoji ou nome do ícone
  ativo       Boolean  @default(true)
  criadoEm    DateTime @default(now())
  
  contasPagar     ContaPagar[]
  contasReceber   ContaReceber[]
}

model ContaReceber {
  id              String    @id @default(uuid())
  clienteId       String?
  descricao       String
  valor           Decimal   @db.Decimal(10, 2)
  dataVencimento  DateTime
  dataRecebimento DateTime?
  status          String    @default("pendente") // pendente, pago, atrasado, cancelado
  categoriaId     String?
  vendaId         String?   @unique
  parcelaId       String?   @unique
  observacoes     String?
  dataCriacao     DateTime  @default(now())
  usuarioId       String?
  
  cliente         Cliente?    @relation(fields: [clienteId], references: [id])
  categoria       Categoria?  @relation(fields: [categoriaId], references: [id])
  venda           Venda?      @relation(fields: [vendaId], references: [id])
  parcela         Parcela?    @relation(fields: [parcelaId], references: [id])
}

model ContaPagar {
  id              String      @id @default(uuid())
  fornecedorId    String?
  descricao       String
  valor           Decimal     @db.Decimal(10, 2)
  dataVencimento  DateTime
  dataPagamento   DateTime?
  status          String      @default("pendente") // pendente, pago, atrasado, cancelado
  categoriaId     String?
  observacoes     String?
  dataCriacao     DateTime    @default(now())
  usuarioId       String?
  
  fornecedor      Fornecedor? @relation(fields: [fornecedorId], references: [id])
  categoria       Categoria?  @relation(fields: [categoriaId], references: [id])
}

model Caixa {
  id          String   @id @default(uuid())
  data        DateTime @default(now())
  tipo        String   // abertura, fechamento, sangria, reforco
  valor       Decimal  @db.Decimal(10, 2)
  saldoAnterior Decimal @db.Decimal(10, 2)
  saldoAtual  Decimal  @db.Decimal(10, 2)
  observacoes String?
  usuarioId   String?
}

// ===== CONFIGURAÇÕES DE CREDIÁRIO =====
model CreditoConfig {
  id                          String   @id @default(uuid())
  taxaPadraoMensal            Decimal  @default(8.0) @db.Decimal(5, 2)  // 8% ao mês
  tipoJurosPadrao             String   @default("COMPOSTO")  // SIMPLES ou COMPOSTO
  multaAtrasoPercentual       Decimal  @default(2.0) @db.Decimal(5, 2)  // 2%
  jurosDiarioAtrasoPercentual Decimal  @default(0.033) @db.Decimal(5, 3) // 0.033% ao dia = ~1%/mês
  ativo                       Boolean  @default(true)
  criadoEm                    DateTime @default(now())
  atualizadoEm                DateTime @updatedAt
  
  @@index([ativo])
}

// ===== CONFIGURAÇÕES =====
model Configuracao {
  id    String @id @default(uuid())
  chave String @unique
  valor String
}

// ===== ORÇAMENTOS E PEDIDOS PERSONALIZADOS =====
model Orcamento {
  id                  String    @id @default(uuid())
  numero              String    @unique
  clienteId           String?
  usuarioId           String
  dataEmissao         DateTime  @default(now())
  validadeAte         DateTime?
  status              String    @default("pendente") // pendente, aprovado, recusado, expirado
  
  subtotal            Decimal   @db.Decimal(10, 2)
  desconto            Decimal   @default(0) @db.Decimal(10, 2)
  total               Decimal   @db.Decimal(10, 2)
  
  observacoes         String?   @db.Text
  observacoesInternas String?   @db.Text
  
  dataAprovacao       DateTime?
  dataRecusa          DateTime?
  motivoRecusa        String?
  
  cliente             Cliente?  @relation(fields: [clienteId], references: [id])
  usuario             Usuario   @relation(fields: [usuarioId], references: [id])
  itens               ItemOrcamento[]
  pedido              Pedido?
}

model ItemOrcamento {
  id              String    @id @default(uuid())
  orcamentoId     String
  produtoId       String?
  descricao       String
  quantidade      Int       @default(1)
  precoUnit       Decimal   @db.Decimal(10, 2)
  subtotal        Decimal   @db.Decimal(10, 2)
  especificacoes  String?   @db.Text
  tempoEstimado   Int?
  
  orcamento       Orcamento @relation(fields: [orcamentoId], references: [id], onDelete: Cascade)
  produto         Produto?  @relation(fields: [produtoId], references: [id])
}

model Pedido {
  id              String    @id @default(uuid())
  numero          String    @unique
  orcamentoId     String?   @unique
  clienteId       String?
  usuarioId       String
  vendaId         String?   @unique
  dataCriacao     DateTime  @default(now())
  dataEntrega     DateTime?
  status          String    @default("producao") // producao, pronto, entregue, cancelado
  
  subtotal        Decimal   @db.Decimal(10, 2)
  desconto        Decimal   @default(0) @db.Decimal(10, 2)
  total           Decimal   @db.Decimal(10, 2)
  
  custoMaterial   Decimal   @default(0) @db.Decimal(10, 2)
  custoMaoObra    Decimal   @default(0) @db.Decimal(10, 2)
  custoTotal      Decimal   @default(0) @db.Decimal(10, 2)
  margemReal      Decimal?  @db.Decimal(10, 2)
  
  observacoes     String?   @db.Text
  
  orcamento       Orcamento? @relation(fields: [orcamentoId], references: [id])
  cliente         Cliente?   @relation(fields: [clienteId], references: [id])
  usuario         Usuario    @relation(fields: [usuarioId], references: [id])
  venda           Venda?     @relation(fields: [vendaId], references: [id])
  itens           ItemPedido[]
  custos          CustoPedido[]
}

model ItemPedido {
  id              String    @id @default(uuid())
  pedidoId        String
  produtoId       String?
  descricao       String
  quantidade      Int
  precoUnit       Decimal   @db.Decimal(10, 2)
  subtotal        Decimal   @db.Decimal(10, 2)
  especificacoes  String?   @db.Text
  
  statusProducao  String    @default("pendente") // pendente, producao, concluido
  dataInicio      DateTime?
  dataConclusao   DateTime?
  
  pedido          Pedido    @relation(fields: [pedidoId], references: [id], onDelete: Cascade)
  produto         Produto?  @relation(fields: [produtoId], references: [id])
}

model CustoPedido {
  id          String   @id @default(uuid())
  pedidoId    String
  tipo        String   // material, mao_obra, terceiros, outros
  descricao   String
  valor       Decimal  @db.Decimal(10, 2)
  data        DateTime @default(now())
  usuarioId   String
  
  pedido      Pedido   @relation(fields: [pedidoId], references: [id], onDelete: Cascade)
  usuario     Usuario  @relation(fields: [usuarioId], references: [id])
}

// ===== COMPRAS =====
model PedidoCompra {
  id              String    @id @default(uuid())
  numero          String    @unique
  fornecedorId    String?
  usuarioId       String
  dataPedido      DateTime  @default(now())
  dataRecebimento DateTime?
  status          String    @default("pendente") // pendente, recebido, cancelado
  
  subtotal        Decimal   @db.Decimal(10, 2)
  desconto        Decimal   @default(0) @db.Decimal(10, 2)
  total           Decimal   @db.Decimal(10, 2)
  
  observacoes     String?
  
  fornecedor      Fornecedor? @relation(fields: [fornecedorId], references: [id])
  itens           ItemPedidoCompra[]
}

model ItemPedidoCompra {
  id              String  @id @default(uuid())
  pedidoCompraId  String
  produtoId       String
  quantidade      Int
  precoCusto      Decimal @db.Decimal(10, 2)
  subtotal        Decimal @db.Decimal(10, 2)
  
  pedidoCompra    PedidoCompra @relation(fields: [pedidoCompraId], references: [id], onDelete: Cascade)
  produto         Produto      @relation(fields: [produtoId], references: [id])
}

// ===== CONFIGURAÇÃO PIX =====
model PixConfig {
  id              Int      @id @default(autoincrement())
  nomeRecebedor   String
  chavePix        String
  cidade          String
  descricaoPadrao String   @default("Venda Lótus Core")
  nomeLoja        String
  ativo           Boolean  @default(true)
  criadoEm        DateTime @default(now())
  atualizadoEm    DateTime @updatedAt

  @@map("pix_config")
}

// ===== NOTIFICAÇÕES =====
model Notification {
  id        Int      @id @default(autoincrement())
  title     String
  message   String
  type      String   // 'update', 'bug', 'alert', 'info'
  isGlobal  Boolean  @default(true)
  userId    String?
  user      Usuario? @relation(fields: [userId], references: [id], onDelete: Cascade)
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([isRead])
}
